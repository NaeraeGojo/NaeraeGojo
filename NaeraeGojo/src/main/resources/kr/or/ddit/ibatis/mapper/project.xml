<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="project">
	<typeAlias alias="projectVO" type="kr.or.ddit.vo.ProjectVO"/>
	<typeAlias alias="joinVO" type="kr.or.ddit.vo.JoinVO"/>
	<typeAlias alias="suggestVO" type="kr.or.ddit.vo.SuggestVO"/>
	
	<resultMap id="projectMap" class="projectVO">
		<result property="project_code" column="project_code"/>
		<result property="project_start" column="project_start"/>
		<result property="project_end" column="project_end"/>
		<result property="project_name" column="project_name"/>
		<result property="suggest_cost" column="suggest_cost"/>
		<result property="rqpps_notice_agency" column="rqpps_notice_agency"/>
	</resultMap>
	
	<sql id="selectAll">
		SELECT
    		A.PROJECT_CODE 
		    ,TO_CHAR(PROJECT_START, 'YYYY-MM-DD') AS PROJECT_START
		    ,TO_CHAR(PROJECT_END, 'YYYY-MM-DD') AS PROJECT_END
		    ,A.PROJECT_NAME
		    ,NVL(TRUNC(AVG(PW_PERCENT)), 0) AS PW_PERCENT
		FROM PROJECT A
		LEFT OUTER JOIN PW B 
		ON (A.PROJECT_CODE = B.PROJECT_CODE)
		AND PROJECT_DELETE = 'n'
		GROUP BY A.PROJECT_CODE, A.PROJECT_NAME, A.PROJECT_START, A.PROJECT_END
	</sql>
	
	<sql id="selectJoinAll">
		SELECT 
		    A.EMP_CODE
		    ,B.EMP_NAME
		FROM JOIN A, EMP B, RQPPS C, SUGGEST D, PROJECT E
        WHERE A.EMP_CODE = B.EMP_CODE
        AND A.RQPPS_CODE = C.RQPPS_CODE
        AND C.RQPPS_CODE = D.RQPPS_CODE
        AND D.SUGGEST_CODE = E.SUGGEST_CODE
        AND E.PROJECT_CODE = #project_code#
	</sql>
	
	<sql id="searchCondition">
		<dynamic>
	 		<isNotEmpty property="search_keyword" prepend="and">
	 			<isEqual property="search_keycode" compareValue="TOTAL" open="(" close=")">  
	 				   PROJECT_NAME LIKE '%' || #search_keyword# || '%'
	 				OR PROJECT_START   LIKE '%' || #search_keyword# || '%'
	 			</isEqual>
	 			<isEqual property="search_keycode" compareValue="NAME" >  
	 					PROJECT_NAME LIKE '%' || #search_keyword# || '%'
	 			</isEqual>
	 		</isNotEmpty>
	 	</dynamic>
	</sql>
	
	<select id="projectList" resultClass="projectVO" parameterClass="map">
		SELECT B.*
		FROM  (SELECT ROWNUM RNUM, A.*
				FROM ( <include refid="selectAll"/> 
						<include refid="searchCondition"/> 
						ORDER BY PROJECT_CODE) A ) B
 		<![CDATA[				
  		WHERE B.RNUM <= #startCount#  
  		 AND  B.RNUM >= #endCount#  
  		]]>  
		ORDER BY B.RNUM DESC
	</select>	
	
	<select id="projectInfo" parameterClass="map" resultMap="projectMap">
		SELECT A.PROJECT_CODE
			   ,TO_CHAR(A.PROJECT_START, 'YYYY-MM-DD') AS PROJECT_START
			   ,TO_CHAR(A.PROJECT_END, 'YYYY-MM-DD') AS PROJECT_END
			   ,A.PROJECT_NAME
               ,B.RQPPS_NOTICE_AGENCY
               ,TO_CHAR(SUGGEST_COST,'9,999,999,999,999') AS SUGGEST_COST
		FROM PROJECT A, RQPPS B, SUGGEST C
      	WHERE A.SUGGEST_CODE = C.SUGGEST_CODE
        AND B.RQPPS_CODE = C.RQPPS_CODE
        AND A.PROJECT_CODE = #project_code#
	</select>
	
	<update id="updateProject" parameterClass="projectVO">
		UPDATE PROJECT
		   SET
		       PROJECT_NAME = #project_name#
		   	  ,PROJECT_START = #project_start# 
 			  ,PROJECT_END  = #project_end#
		 WHERE PROJECT_CODE = #project_code#
	</update>
	
	<update id="deleteProject" parameterClass="map">
		UPDATE PROJECT
		   SET PROJECT_DELETE = 'y'
		 WHERE PROJECT_CODE   = #project_code#
	</update>
	
	<select id="totalCountPL" parameterClass="map" resultClass="int">
		SELECT 
		    COUNT(PROJECT_CODE)
		FROM PROJECT
		WHERE PROJECT_DELETE = 'n'
	</select>
	
	
	
	<select id="joinList" resultClass="JoinVO" parameterClass="map">
		SELECT B.*
		FROM  (SELECT ROWNUM RNUM, A.*
				FROM ( <include refid="selectJoinAll"/> 
						ORDER BY EMP_CODE) A ) B
 		<![CDATA[				
 		WHERE B.RNUM <= #startCount# 
 		 AND  B.RNUM >= #endCount# 
 		]]> 
		ORDER BY B.RNUM DESC
	</select>
	
	<select id="suggestList" resultClass="suggestVO" parameterClass="map">
		SELECT 
		    SUGGEST_CODE
		    ,SUGGEST_TITLE
		FROM SUGGEST
	</select>
	
	<select id="suggestInfo" parameterClass="map" resultClass="suggestVO">
		SELECT 
		     A.SUGGEST_CODE
			,A.SUGGEST_TITLE
			,A.SUGGEST_CONTENT
			,A.SUGGEST_RESULT
			,TO_CHAR(A.SUGGEST_START_DATE, 'YYYY-MM-DD') AS SUGGEST_START_DATE
			,TO_CHAR(A.SUGGEST_END_DATE, 'YYYY-MM-DD') AS SUGGEST_END_DATE
			,LTRIM(TO_CHAR(SUGGEST_COST,'9,999,999,999,999')) AS SUGGEST_COST
		    ,B.RQPPS_NOTICE_AGENCY
		FROM SUGGEST A, RQPPS B
		WHERE A.RQPPS_CODE = B.RQPPS_CODE
		AND A.SUGGEST_CODE = #suggest_code#
	</select>
	
	<select id="totalCount" parameterClass="map" resultClass="int">
		SELECT 
		    COUNT(A.EMP_CODE)
		FROM JOIN A, EMP B, RQPPS C, SUGGEST D, PROJECT E
        WHERE A.EMP_CODE = B.EMP_CODE
        AND A.RQPPS_CODE = C.RQPPS_CODE
        AND C.RQPPS_CODE = D.RQPPS_CODE
        AND D.SUGGEST_CODE = E.SUGGEST_CODE
        AND E.PROJECT_CODE = #project_code#
	</select>
	
	
	
	
</sqlMap>


